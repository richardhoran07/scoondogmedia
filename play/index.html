<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Playground | SCOONDOG156</title>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

<style>
  :root{
    --ink:#d61a1a;
  }
  html,body{
    margin:0; height:100%; overflow:hidden; background:#000;
    color:#ffd7d7; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  }
  #ui{
    position:fixed; inset:0; pointer-events:none;
  }
  .title{
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    font-family:'UnifrakturCook', cursive; color:var(--ink); font-size:clamp(20px,3vw,36px);
    text-shadow:0 0 12px rgba(214,26,26,.4);
    pointer-events:auto;
  }
  .btnbar{
    position:absolute; top:60px; left:50%; transform:translateX(-50%);
    display:flex; gap:.6rem; pointer-events:auto;
  }
  button, select{
    background:#000; color:var(--ink); border:2px solid var(--ink);
    padding:.4rem .7rem; font-weight:600; cursor:pointer;
    box-shadow:0 0 12px rgba(214,26,26,.25);
  }
  button:active{ transform:translateY(1px); }
  #startGate{
    position:fixed; inset:0; display:grid; place-items:center;
    background:radial-gradient(closest-side at 50% 40%, rgba(214,26,26,.20), transparent 60%), #000;
  }
  #startGate .panel{
    text-align:center; padding:1rem 1.25rem; border:3px double var(--ink); background:rgba(0,0,0,.85);
  }
  #startGate h1{ font-family:'UnifrakturCook',cursive; color:var(--ink); margin:.2rem 0 .8rem; }
  #footer{
    position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
    font-size:.85rem; color:var(--ink); text-shadow:0 0 8px rgba(214,26,26,.4);
    pointer-events:auto;
  }
</style>
</head>
<body>

<canvas id="c"></canvas>

<div id="ui">
  <div class="title">PLAYGROUND</div>
  <div class="btnbar">
    <select id="spawnType">
      <option value="blob">Blob</option>
      <option value="box">Box</option>
      <option value="seed">Seed</option>
    </select>
    <button id="spawnBtn">Spawn (click canvas too)</button>
    <button id="clearBtn">Clear</button>
  </div>
  <div id="footer">© <span id="year"></span> SCOONDOG156 · drag / click to toss things</div>
</div>

<!-- Mobile / Audio unlock -->
<div id="startGate">
  <div class="panel">
    <h1>PLAYGROUND</h1>
    <p style="margin:.4rem 0 1rem; color:#ffd7d7">
      Tap <em>Start</em> to unlock audio & begin the toybox.
    </p>
    <button id="startBtn">Start</button>
  </div>
</div>

<!-- libs -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/",
    "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js",
    "tone": "https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"
  }
}
</script>

<script type="module">
/* -------------------------------------------------------
   Imports
------------------------------------------------------- */
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import * as CANNON from 'cannon-es';
import * as Tone from 'tone';

/* -------------------------------------------------------
   Basic scene
------------------------------------------------------- */
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);

const scene  = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 200);
camera.position.set(0, 6.5, 11);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.target.set(0,2,0);

/* -------------------------------------------------------
   Lights + sky gradient
------------------------------------------------------- */
const hemi = new THREE.HemisphereLight(0xffffff, 0x223344, 0.8);
scene.add(hemi);
const dir  = new THREE.DirectionalLight(0xffffff, 1.0);
dir.position.set(5,10,2);
dir.castShadow = true;
dir.shadow.mapSize.set(1024,1024);
scene.add(dir);

// gradient sky as big sphere
const skyGeo = new THREE.SphereGeometry(100,32,16);
const skyMat = new THREE.ShaderMaterial({
  side: THREE.BackSide,
  uniforms: {
    top:   { value: new THREE.Color(0x0a0e1a) },
    mid:   { value: new THREE.Color(0x20304a) },
    bot:   { value: new THREE.Color(0x000000) },
    t:     { value: 0 }
  },
  vertexShader: `
    varying vec3 vPos;
    void main(){
      vPos = position;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }
  `,
  fragmentShader: `
    varying vec3 vPos;
    uniform vec3 top; uniform vec3 mid; uniform vec3 bot; uniform float t;
    void main(){
      float h = normalize(vPos).y * .5 + .5;
      vec3 c = mix(mix(bot, mid, smoothstep(0.1,0.6,h)), top, smoothstep(0.6,1.0,h));
      // subtle pulsing with music (t)
      c += vec3(0.02,0.01,0.03) * t;
      gl_FragColor = vec4(c,1.0);
    }
  `
});
const sky = new THREE.Mesh(skyGeo, skyMat);
scene.add(sky);

/* -------------------------------------------------------
   Ground (soft clay look)
------------------------------------------------------- */
const groundGeo = new THREE.CapsuleGeometry(40, 1, 8, 32);
const groundMat = new THREE.MeshToonMaterial({ color:0x1a1a1f, gradientMap:null });
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
ground.position.y = -2.2;
ground.receiveShadow = true;
scene.add(ground);

/* -------------------------------------------------------
   Physics world
------------------------------------------------------- */
const world = new CANNON.World({ gravity: new CANNON.Vec3(0,-12,0) });
world.broadphase = new CANNON.SAPBroadphase(world);
world.solver.iterations = 12;

// ground body
const groundBody = new CANNON.Body({
  mass:0, shape:new CANNON.Plane(), material:new CANNON.Material('ground')
});
groundBody.quaternion.setFromEuler(-Math.PI/2,0,0);
world.addBody(groundBody);

// contact materials (bouncy / soft)
const soft = new CANNON.Material('soft');
world.addContactMaterial(new CANNON.ContactMaterial(soft, soft, { friction:0.2, restitution:0.65 }));
world.addContactMaterial(new CANNON.ContactMaterial(soft, groundBody.material, { friction:0.3, restitution:0.65 }));

/* -------------------------------------------------------
   Generative Audio (Tone.js)
------------------------------------------------------- */
let audioReady = false;

const reverb = new Tone.Reverb({ decay:6, wet:0.4 }).toDestination();
const delay  = new Tone.FeedbackDelay({ delayTime:0.25, feedback:0.25, wet:0.2 }).toDestination();
const limiter= new Tone.Limiter(-2).toDestination();

const pad = new Tone.PolySynth(Tone.Synth, {
  oscillator:{ type:'sine' },
  envelope:{ attack:2, decay:1.5, sustain:0.6, release:4 }
}).connect(reverb).connect(delay).connect(limiter);

const flute = new Tone.Synth({
  oscillator:{ type:'sine' },
  portamento:0.02,
  envelope:{ attack:0.02, decay:0.3, sustain:0.2, release:0.6 }
}).connect(reverb).connect(limiter);

const drum = new Tone.MembraneSynth({
  pitchDecay:0.02, octaves:4, envelope:{ attack:0.001, decay:0.35, sustain:0, release:0.15 }
}).connect(limiter);

// Ambient pad loop (airy)
const scale = ["C4","D4","G4","A4","D5","E5","G5"];
let padIndex = 0;
const padLoop = new Tone.Loop(time=>{
  if(!audioReady) return;
  const chord = [scale[padIndex%7], scale[(padIndex+2)%7], scale[(padIndex+4)%7]];
  chord.forEach(n => pad.triggerAttackRelease(n, "4n", time));
  padIndex++;
}, "2m");

Tone.Transport.bpm.value = 84;

/* Visual motes on flute notes */
const moteGeo = new THREE.SphereGeometry(0.05, 10, 10);
const moteMat = new THREE.MeshBasicMaterial({ color:0xffbbff, transparent:true, opacity:0.9 });
const motes = [];
function spawnMote(pos){
  const m = new THREE.Mesh(moteGeo, moteMat.clone());
  m.position.copy(pos);
  m.userData.life = 1.2;
  scene.add(m);
  motes.push(m);
}

/* -------------------------------------------------------
   Spawnables
------------------------------------------------------- */
const things = [];

function clayMaterial(color){
  // Toon + slight emissive to feel plasticky
  return new THREE.MeshToonMaterial({
    color, emissive: new THREE.Color(color).multiplyScalar(0.08)
  });
}

function jiggle(mesh, t){
  // tiny vertex jiggle to feel handmade
  mesh.rotation.x += Math.sin(t*0.7 + mesh.id)*0.0004;
  mesh.rotation.y += Math.cos(t*0.9 + mesh.id)*0.0005;
}

function addBlob(pos=new THREE.Vector3(0,5,0)){
  const r = THREE.MathUtils.randFloat(0.4,0.9);
  const geo = new THREE.IcosahedronGeometry(r, 2);
  const mat = clayMaterial(0xf9a9ff);
  const mesh= new THREE.Mesh(geo, mat);
  mesh.castShadow = true; mesh.receiveShadow = true;
  scene.add(mesh);

  const body = new CANNON.Body({ mass: r*2, material:soft });
  body.addShape(new CANNON.Sphere(r*0.9));
  body.position.set(pos.x, pos.y, pos.z);
  body.linearDamping = 0.2;
  world.addBody(body);

  things.push({ mesh, body, type:'blob' });
  return body;
}

function addBox(pos=new THREE.Vector3(0,6,0)){
  const s = THREE.MathUtils.randFloat(0.5,1.0);
  const geo = new THREE.BoxGeometry(s, s, s);
  const mat = clayMaterial(0xaef6ff);
  const mesh= new THREE.Mesh(geo, mat);
  mesh.castShadow = true; mesh.receiveShadow = true;
  scene.add(mesh);

  const body = new CANNON.Body({ mass: s*2, material:soft });
  body.addShape(new CANNON.Box(new CANNON.Vec3(s/2,s/2,s/2)));
  body.position.set(pos.x, pos.y, pos.z);
  body.angularDamping = 0.2;
  world.addBody(body);

  things.push({ mesh, body, type:'box' });
  return body;
}

function addSeed(pos=new THREE.Vector3(0,7,0)){
  const geo = new THREE.CapsuleGeometry(0.25, 0.35, 6, 12);
  const mat = clayMaterial(0xfff3a0);
  const mesh= new THREE.Mesh(geo, mat);
  mesh.castShadow = true; mesh.receiveShadow = true;
  scene.add(mesh);

  const body = new CANNON.Body({ mass: 0.8, material:soft });
  body.addShape(new CANNON.Sphere(0.28));
  body.position.set(pos.x, pos.y, pos.z);
  world.addBody(body);

  things.push({ mesh, body, type:'seed' });
  return body;
}

/* collision → sound */
world.addEventListener('postStep', ()=>{
  // scan recent contacts (simple heuristic)
  for (let i=0; i<world.narrowphase.contactEquations.length; i++){
    const c = world.narrowphase.contactEquations[i];
    const relVel = c.bi.velocity.vsub(c.bj.velocity).length();
    if (relVel > 1.6 && Math.random()<0.15){
      // musical mapping
      const note = scale[Math.floor(Math.random()*scale.length)];
      if(audioReady){
        flute.triggerAttackRelease(note, "8n");
        drum.triggerAttackRelease("C2","32n", undefined, Math.min(0.2, relVel/12));
      }
      // sparkle
      const p = new THREE.Vector3().copy(c.bi.position).lerp(c.bj.position, 0.5);
      spawnMote(p);
    }
  }
});

/* -------------------------------------------------------
   Input: spawn on click/tap
------------------------------------------------------- */
const spawnTypeSel = document.getElementById('spawnType');
const spawnBtn     = document.getElementById('spawnBtn');
const clearBtn     = document.getElementById('clearBtn');

function screenToWorld(x,y){
  const ndc = new THREE.Vector2(
    (x/innerWidth)*2 - 1,
    -(y/innerHeight)*2 + 1
  );
  const ray = new THREE.Raycaster();
  ray.setFromCamera(ndc, camera);
  const p = ray.ray.origin.clone().add(ray.ray.direction.clone().multiplyScalar(8));
  return p;
}

function spawnAtPointer(ev){
  const p = (ev.touches && ev.touches[0]) ? ev.touches[0] : ev;
  const pos = screenToWorld(p.clientX, p.clientY);
  const impulse = new CANNON.Vec3((Math.random()-.5)*6, 8+(Math.random()*2), (Math.random()-.5)*6);

  let b;
  const kind = spawnTypeSel.value;
  if (kind==='blob') b = addBlob(pos);
  else if (kind==='box') b = addBox(pos);
  else b = addSeed(pos);

  b.applyImpulse(impulse, b.position);
}

renderer.domElement.addEventListener('pointerdown', spawnAtPointer, { passive:true });
renderer.domElement.addEventListener('touchstart', spawnAtPointer, { passive:true });
spawnBtn.addEventListener('click', ()=> spawnAtPointer({ clientX: innerWidth/2, clientY: innerHeight/2 }));

clearBtn.addEventListener('click', ()=>{
  for (const t of things){
    scene.remove(t.mesh);
    world.removeBody(t.body);
  }
  things.length = 0;
});

/* -------------------------------------------------------
   Resize
------------------------------------------------------- */
addEventListener('resize', ()=>{
  renderer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
});

/* -------------------------------------------------------
   Start gate (unlock audio)
------------------------------------------------------- */
document.getElementById('year').textContent = new Date().getFullYear();
const startGate = document.getElementById('startGate');
document.getElementById('startBtn').addEventListener('click', async ()=>{
  await Tone.start();
  audioReady = true;
  padLoop.start(0);
  Tone.Transport.start();
  startGate.style.display = 'none';
});

/* -------------------------------------------------------
   Animate
------------------------------------------------------- */
const clock = new THREE.Clock();

function animate(){
  requestAnimationFrame(animate);
  const dt = Math.min(0.033, clock.getDelta());

  // physics
  world.step(1/60, dt, 3);

  // sync meshes
  const t = performance.now()*0.001;
  for(const obj of things){
    obj.mesh.position.copy(obj.body.position);
    obj.mesh.quaternion.copy(obj.body.quaternion);
    jiggle(obj.mesh, t);
  }

  // mote life
  for(let i=motes.length-1;i>=0;i--){
    const m = motes[i];
    m.userData.life -= dt;
    m.position.y += dt*0.8;
    m.material.opacity = Math.max(0, m.userData.life);
    if (m.userData.life<=0){
      scene.remove(m);
      motes.splice(i,1);
    }
  }

  // sky reacts slightly to scene motion
  let motion = 0;
  for(const obj of things) motion += obj.body.velocity.length();
  skyMat.uniforms.t.value = Math.min(0.25, motion/200);

  controls.update();
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
